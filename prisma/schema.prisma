generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Workspace {
  id                String   @id @default(cuid())
  slug              String   @unique
  slackTeamId       String   @unique
  slackTeamName     String
  slackTeamIcon     String?
  slackBotToken     String
  slackBotUserId    String
  installedByUserId String
  checkoutToken     String?  @unique
  isActive           Boolean  @default(true)
  needsReconnection   Boolean  @default(false)
  onboardingCompleted Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  channels       Channel[]
  subscription   Subscription?
  quotes         Quote[]
  styles         Style[]
  workspaceUsers WorkspaceUser[]
  collections    Collection[]

}

model WorkspaceUser {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  role        String   @default("member")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model Subscription {
  id                   String             @id @default(cuid())
  workspaceId          String             @unique
  workspace            Workspace          @relation(fields: [workspaceId], references: [id])
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  monthlyQuota         Int                @default(5)
  bonusCredits         Int                @default(0)
  maxChannels          Int                @default(1)
  hasWatermark         Boolean            @default(true)
  imageSize            String             @default("1792x1024")
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

}

enum SubscriptionTier {
  FREE
  STARTER
  TEAM
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  UNPAID
}

model Channel {
  id             String    @id @default(cuid())
  workspaceId    String
  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  slackChannelId String
  channelName    String
  isActive       Boolean   @default(true)
  isPaused       Boolean   @default(false)
  styleMode         StyleMode @default(RANDOM)
  postToChannelId   String?
  postToChannelName String?
  quoteOriginal     Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  quotes        Quote[]
  channelStyles ChannelStyle[]

  @@unique([workspaceId, slackChannelId])
}

model Quote {
  id              String      @id @default(cuid())
  workspaceId     String
  workspace       Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channelId       String
  channel         Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  slackMessageTs  String
  slackUserId     String
  slackUserName      String
  slackUserAvatarUrl String?
  quoteText       String
  attributedTo    String?
  styleId         String
  imageUrl        String?
  slackPermalink  String?
  status          QuoteStatus @default(PENDING)
  aiConfidence    Float?
  isFavorited     Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  imageGenerations ImageGeneration[]
  collectionQuotes CollectionQuote[]

  @@unique([workspaceId, slackMessageTs])
  @@index([workspaceId, createdAt])
  @@index([workspaceId, status])
}

enum QuoteStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

model ImageGeneration {
  id                     String                @id @default(cuid())
  quoteId                String
  quote                  Quote                 @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  workspaceId            String
  styleId                String
  customStyleDescription String?
  imagePrompt            String?
  imageUrl               String?
  status                 ImageGenerationStatus @default(PENDING)
  processingError        String?
  qstashMessageId        String?
  attemptNumber          Int                   @default(1)
  startedAt              DateTime?
  completedAt            DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  @@index([quoteId])
  @@index([workspaceId, status])
  @@index([workspaceId, createdAt])
}

enum ImageGenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum StyleMode {
  RANDOM
  AI
}

model Style {
  id          String     @id @default(cuid())
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name        String
  displayName String
  description String
  prompt      String     @default("")
  createdBy        String?
  isActive         Boolean    @default(true)
  isFree           Boolean    @default(false)
  enabledByDefault Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  channelStyles ChannelStyle[]

  @@unique([workspaceId, name])
}

model ChannelStyle {
  id        String   @id @default(cuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  styleId   String
  style     Style    @relation(fields: [styleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([channelId, styleId])
}

model UsageRecord {
  id          String   @id @default(cuid())
  workspaceId String
  periodStart DateTime
  periodEnd   DateTime
  quotesUsed  Int      @default(0)
  quotaLimit  Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([workspaceId, periodStart])
  @@index([workspaceId, periodStart])
}

model TokenPurchase {
  id                String   @id @default(cuid())
  workspaceId       String
  stripeSessionId   String   @unique
  stripeCustomerId  String
  packType          String
  creditsAdded      Int
  amountPaid        Int
  purchasedByUserId String?
  createdAt         DateTime @default(now())

  @@index([workspaceId, createdAt])
}

model ContactFormSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String
  status    String   @default("new")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String?
  slackUserId    String?   @unique
  name           String?
  emailVerified  DateTime?
  isAdmin        Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  workspaceUsers         WorkspaceUser[]
  emailVerificationCodes EmailVerificationCode[]

}

model SlackEvent {
  id          String   @id @default(cuid())
  eventType   String
  teamId      String?
  channel     String?
  userId      String?
  messageTs   String?
  rawBody     String
  endpoint    String
  processedOk Boolean  @default(true)
  error       String?
  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([teamId])
  @@index([createdAt])
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  token     String?  @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([token])
  @@index([expires])
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  emoji       String?
  sortOrder   Int      @default(0)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  collectionQuotes CollectionQuote[]

  @@index([workspaceId])
  @@index([workspaceId, sortOrder])
}

model CollectionQuote {
  id           String   @id @default(cuid())
  quoteId      String
  collectionId String
  createdAt    DateTime @default(now())

  quote      Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([quoteId, collectionId])
  @@index([quoteId])
  @@index([collectionId])
}
